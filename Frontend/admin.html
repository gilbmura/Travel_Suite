<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Travel Suite Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Poppins', sans-serif; background: #f5f7fa; color: #333; display: flex; }

  .sidebar { width: 250px; background: #2c3e50; color: white; padding: 20px; height: 100vh; overflow-y: auto; position: fixed; left: 0; top: 0; }
  .sidebar h2 { margin-bottom: 30px; font-size: 20px; }
  .sidebar ul { list-style: none; }
  .sidebar ul li { padding: 12px 15px; cursor: pointer; border-radius: 5px; margin-bottom: 5px; transition: all 0.3s; }
  .sidebar ul li:hover, .sidebar ul li.active { background: #3498db; }

  .main { flex: 1; padding: 30px; overflow-y: auto; margin-left: 250px; }
  h1 { margin-bottom: 25px; color: #2c3e50; }

  .card-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
  .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  .card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.15); }
  .card h3 { color: #3498db; margin-bottom: 10px; }
  .card p { font-size: 24px; font-weight: bold; color: #2c3e50; }

  table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  th, td { padding: 12px; text-align: left; }
  th { background: #3498db; color: white; font-weight: 600; }
  td { color: #111; }
  tr:nth-child(even) td { background: #f5f5f5; }

  button { background: #3498db; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-right: 5px; margin-top: 10px; }
  button:hover { background: #2980b9; }
  button.danger { background: #e74c3c; }
  button.danger:hover { background: #c0392b; }

  form { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
  form input, form select { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px; }
  form label { display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50; }

  section.hidden { display: none; }
  .loading { text-align: center; padding: 20px; }
  .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  .alert { padding: 15px; margin-bottom: 20px; border-radius: 5px; }
  .alert.success { background: #d4edda; color: #155724; }
  .alert.error { background: #f8d7da; color: #721c24; }

  @media(max-width: 900px) { 
    .sidebar { width: 100%; height: auto; position: relative; }
    .main { margin-left: 0; }
  }
</style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
  <h2>üöå Travel Suite</h2>
  <ul>
    <li class="active" onclick="showSection('dashboard')">üìä Dashboard</li>
    <li onclick="showSection('customers')">üë• Customers</li>
    <li onclick="showSection('vehicles')">ÔøΩ Vehicles</li>
    <li onclick="showSection('routes')">üó∫Ô∏è Routes</li>
    <li onclick="showSection('bookings')">üìÖ Bookings</li>
    <li onclick="showSection('tickets')">üé´ Tickets</li>
    <li onclick="showSection('payments')">üí≥ Payments</li>
    <li onclick="logoutUser()">üö™ Logout</li>
  </ul>
</div>

<!-- Main Area -->
<div class="main">

  <!-- Dashboard -->
  <section id="dashboard">
    <h1>üìä Dashboard</h1>
    <div id="dashboardAlert"></div>
    <div class="card-container">
      <div class="card">
        <h3>Total Customers</h3>
        <p id="totalCustomers">0</p>
      </div>
      <div class="card">
        <h3>Total Vehicles</h3>
        <p id="totalVehicles">0</p>
      </div>
      <div class="card">
        <h3>Total Routes</h3>
        <p id="totalRoutes">0</p>
      </div>
      <div class="card">
        <h3>Total Bookings</h3>
        <p id="totalBookings">0</p>
      </div>
    </div>
  </section>

  <!-- Customers -->
  <section id="customers" class="hidden">
    <h1>üë• Customers</h1>
    <div id="customersAlert"></div>
    <form id="addCustomerForm">
      <h3>Add New Customer</h3>
      <label>Name</label>
      <input type="text" id="customerName" placeholder="Full Name" required>
      <label>Phone Number</label>
      <input type="text" id="customerPhone" placeholder="+250..." required>
      <label>National ID</label>
      <input type="text" id="customerID" placeholder="ID Number" required>
      <label>Address</label>
      <input type="text" id="customerAddress" placeholder="Address" required>
      <button type="submit">‚ûï Add Customer</button>
    </form>
    <div id="customersTableContainer"><div class="loading"><div class="loading-spinner"></div></div></div>
  </section>

  <!-- Vehicles -->
  <section id="vehicles" class="hidden">
    <h1>üöê Vehicles</h1>
    <div id="vehiclesAlert"></div>
    <form id="addVehicleForm">
      <h3>Add New Vehicle</h3>
      <label>License Plate</label>
      <input type="text" id="vehicleLicense" placeholder="e.g., RAJ-123-A" required>
      <label>Capacity</label>
      <input type="number" id="vehicleCapacity" placeholder="50" required>
      <label>Status</label>
      <select id="vehicleStatus">
        <option value="Available">Available</option>
        <option value="Unavailable">Unavailable</option>
      </select>
      <button type="submit">‚ûï Add Vehicle</button>
    </form>
    <div id="vehiclesTableContainer"><div class="loading"><div class="loading-spinner"></div></div></div>
  </section>

  <!-- Routes -->
  <section id="routes" class="hidden">
    <h1>üó∫Ô∏è Routes</h1>
    <div id="routesAlert"></div>
    <form id="addRouteForm">
      <h3>Add New Route</h3>
      <label>Origin</label>
      <input type="text" id="routeOrigin" placeholder="e.g., Kigali" required>
      <label>Destination</label>
      <input type="text" id="routeDestination" placeholder="e.g., Butare" required>
      <label>Departure Time</label>
      <input type="time" id="routeDepTime" required>
      <label>Arrival Time</label>
      <input type="time" id="routeArrTime" required>
      <label>Fare</label>
      <input type="number" id="routeFare" step="0.01" placeholder="5000.00" required>
      <button type="submit">‚ûï Add Route</button>
    </form>
    <div id="routesTableContainer"><div class="loading"><div class="loading-spinner"></div></div></div>
  </section>

  <!-- Bookings -->
  <section id="bookings" class="hidden">
    <h1>üìÖ Bookings</h1>
    <div id="bookingsAlert"></div>
    <div id="bookingsTableContainer"><div class="loading"><div class="loading-spinner"></div></div></div>
  </section>

  <!-- Tickets -->
  <section id="tickets" class="hidden">
    <h1>üé´ Tickets</h1>
    <div id="ticketsAlert"></div>
    <div id="ticketsTableContainer"><div class="loading"><div class="loading-spinner"></div></div></div>
  </section>

  <!-- Payments -->
  <section id="payments" class="hidden">
    <h1>üí≥ Payments</h1>
    <div id="paymentsAlert"></div>
    <div id="paymentsTableContainer"><div class="loading"><div class="loading-spinner"></div></div></div>
  </section>

</div>

<script>
const API_BASE = 'http://127.0.0.1:8000/api';
let authToken = localStorage.getItem('authToken');

// Show section
function showSection(id) {
  document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  document.querySelectorAll('.sidebar ul li').forEach(li => li.classList.remove('active'));
  event.target.closest('li').classList.add('active');
  
  if (id === 'dashboard') loadDashboard();
  else if (id === 'customers') loadCustomers();
  else if (id === 'vehicles') loadVehicles();
  else if (id === 'routes') loadRoutes();
  else if (id === 'bookings') loadBookings();
  else if (id === 'tickets') loadTickets();
  else if (id === 'payments') loadPayments();
}

// API Helper
async function apiCall(endpoint, method = 'GET', data = null) {
  const options = {
    method,
    headers: {
      'Content-Type': 'application/json',
      ...(authToken && { 'Authorization': `Bearer ${authToken}` })
    }
  };
  if (data) options.body = JSON.stringify(data);
  
  try {
    const response = await fetch(`${API_BASE}${endpoint}`, options);
    if (response.status === 401) {
      logoutUser();
      return null;
    }
    if (response.status === 204) return true;
    return await response.json();
  } catch (error) {
    console.error('API Error:', error);
    return null;
  }
}

// Alert
function showAlert(sectionId, message, type = 'success') {
  const container = document.getElementById(`${sectionId}Alert`);
  if (!container) return;
  
  const alert = document.createElement('div');
  alert.className = `alert ${type}`;
  alert.textContent = message;
  container.innerHTML = '';
  container.appendChild(alert);
  setTimeout(() => alert.remove(), 3000);
}

// Dashboard
async function loadDashboard() {
  const customers = await apiCall('/customers/');
  const vehicles = await apiCall('/vehicles/');
  const routes = await apiCall('/routes/');
  const bookings = await apiCall('/bookings/');
  
  document.getElementById('totalCustomers').textContent = customers?.length || 0;
  document.getElementById('totalVehicles').textContent = vehicles?.length || 0;
  document.getElementById('totalRoutes').textContent = routes?.length || 0;
  document.getElementById('totalBookings').textContent = bookings?.length || 0;
}

// Customers
async function loadCustomers() {
  const data = await apiCall('/customers/');
  if (!data) {
    showAlert('customers', '‚ùå Failed to load customers', 'error');
    return;
  }
  
  let html = '<table><tr><th>ID</th><th>Name</th><th>Phone</th><th>National ID</th><th>Actions</th></tr>';
  data.forEach(c => {
    html += `<tr>
      <td>${c.id}</td>
      <td>${c.name}</td>
      <td>${c.phone_number}</td>
      <td>${c.national_id}</td>
      <td><button onclick="deleteCustomer(${c.id})" class="danger">Delete</button></td>
    </tr>`;
  });
  html += '</table>';
  document.getElementById('customersTableContainer').innerHTML = html;
}

async function deleteCustomer(id) {
  if (!confirm('Delete this customer?')) return;
  const result = await apiCall(`/customers/${id}/`, 'DELETE');
  if (result !== null) {
    showAlert('customers', '‚úÖ Customer deleted', 'success');
    loadCustomers();
  } else {
    showAlert('customers', '‚ùå Failed to delete customer', 'error');
  }
}

document.getElementById('addCustomerForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const data = {
    name: document.getElementById('customerName').value,
    phone_number: document.getElementById('customerPhone').value,
    national_id: document.getElementById('customerID').value,
    address: document.getElementById('customerAddress').value
  };
  const result = await apiCall('/customers/', 'POST', data);
  if (result) {
    showAlert('customers', '‚úÖ Customer added successfully', 'success');
    document.getElementById('addCustomerForm').reset();
    loadCustomers();
  } else {
    showAlert('customers', '‚ùå Failed to add customer', 'error');
  }
});

// Vehicles
async function loadVehicles() {
  const data = await apiCall('/vehicles/');
  if (!data) {
    showAlert('vehicles', '‚ùå Failed to load vehicles', 'error');
    return;
  }
  
  let html = '<table><tr><th>ID</th><th>License Plate</th><th>Capacity</th><th>Status</th><th>Actions</th></tr>';
  data.forEach(v => {
    html += `<tr>
      <td>${v.id}</td>
      <td>${v.license_plate}</td>
      <td>${v.capacity}</td>
      <td>${v.status}</td>
      <td><button onclick="deleteVehicle(${v.id})" class="danger">Delete</button></td>
    </tr>`;
  });
  html += '</table>';
  document.getElementById('vehiclesTableContainer').innerHTML = html;
}

async function deleteVehicle(id) {
  if (!confirm('Delete this vehicle?')) return;
  const result = await apiCall(`/vehicles/${id}/`, 'DELETE');
  if (result !== null) {
    showAlert('vehicles', '‚úÖ Vehicle deleted', 'success');
    loadVehicles();
  } else {
    showAlert('vehicles', '‚ùå Failed to delete vehicle', 'error');
  }
}

document.getElementById('addVehicleForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const data = {
    license_plate: document.getElementById('vehicleLicense').value,
    capacity: parseInt(document.getElementById('vehicleCapacity').value),
    status: document.getElementById('vehicleStatus').value
  };
  const result = await apiCall('/vehicles/', 'POST', data);
  if (result) {
    showAlert('vehicles', '‚úÖ Vehicle added successfully', 'success');
    document.getElementById('addVehicleForm').reset();
    loadVehicles();
  } else {
    showAlert('vehicles', '‚ùå Failed to add vehicle', 'error');
  }
});

// Routes
async function loadRoutes() {
  const data = await apiCall('/routes/');
  if (!data) {
    showAlert('routes', '‚ùå Failed to load routes', 'error');
    return;
  }
  
  let html = '<table><tr><th>ID</th><th>Origin</th><th>Destination</th><th>Departure</th><th>Arrival</th><th>Fare</th><th>Actions</th></tr>';
  data.forEach(r => {
    html += `<tr>
      <td>${r.id}</td>
      <td>${r.origin}</td>
      <td>${r.destination}</td>
      <td>${r.departure_time}</td>
      <td>${r.arrival_time || 'N/A'}</td>
      <td>${r.fare}</td>
      <td><button onclick="deleteRoute(${r.id})" class="danger">Delete</button></td>
    </tr>`;
  });
  html += '</table>';
  document.getElementById('routesTableContainer').innerHTML = html;
}

async function deleteRoute(id) {
  if (!confirm('Delete this route?')) return;
  const result = await apiCall(`/routes/${id}/`, 'DELETE');
  if (result !== null) {
    showAlert('routes', '‚úÖ Route deleted', 'success');
    loadRoutes();
  } else {
    showAlert('routes', '‚ùå Failed to delete route', 'error');
  }
}

document.getElementById('addRouteForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const data = {
    origin: document.getElementById('routeOrigin').value,
    destination: document.getElementById('routeDestination').value,
    departure_time: document.getElementById('routeDepTime').value,
    arrival_time: document.getElementById('routeArrTime').value,
    fare: parseFloat(document.getElementById('routeFare').value)
  };
  const result = await apiCall('/routes/', 'POST', data);
  if (result) {
    showAlert('routes', '‚úÖ Route added successfully', 'success');
    document.getElementById('addRouteForm').reset();
    loadRoutes();
  } else {
    showAlert('routes', '‚ùå Failed to add route', 'error');
  }
});

// Bookings
async function loadBookings() {
  const data = await apiCall('/bookings/');
  if (!data) {
    showAlert('bookings', '‚ùå Failed to load bookings', 'error');
    return;
  }
  
  let html = '<table><tr><th>ID</th><th>Customer</th><th>Route</th><th>Seat</th><th>Amount</th><th>Status</th><th>Date</th></tr>';
  data.forEach(b => {
    html += `<tr>
      <td>${b.id}</td>
      <td>${b.customer_name || b.customer}</td>
      <td>${b.route}</td>
      <td>${b.seat_number}</td>
      <td>${b.amount}</td>
      <td>${b.status}</td>
      <td>${b.date}</td>
    </tr>`;
  });
  html += '</table>';
  document.getElementById('bookingsTableContainer').innerHTML = html;
}

// Tickets
async function loadTickets() {
  const data = await apiCall('/tickets/');
  if (!data) {
    showAlert('tickets', '‚ùå Failed to load tickets', 'error');
    return;
  }
  
  let html = '<table><tr><th>ID</th><th>Booking</th><th>QR Code</th><th>Status</th></tr>';
  data.forEach(t => {
    html += `<tr>
      <td>${t.id}</td>
      <td>${t.booking}</td>
      <td>${t.qr_code.substring(0, 12)}...</td>
      <td>${t.is_used ? 'Used' : 'Unused'}</td>
    </tr>`;
  });
  html += '</table>';
  document.getElementById('ticketsTableContainer').innerHTML = html;
}

// Payments
async function loadPayments() {
  const data = await apiCall('/payments/');
  if (!data) {
    showAlert('payments', '‚ùå Failed to load payments', 'error');
    return;
  }
  
  let html = '<table><tr><th>ID</th><th>Booking</th><th>Amount</th><th>Method</th><th>Status</th></tr>';
  data.forEach(p => {
    html += `<tr>
      <td>${p.id}</td>
      <td>${p.booking}</td>
      <td>${p.amount}</td>
      <td>${p.payment_method}</td>
      <td>${p.status}</td>
    </tr>`;
  });
  html += '</table>';
  document.getElementById('paymentsTableContainer').innerHTML = html;
}

// Logout
function logoutUser() {
  localStorage.removeItem('authToken');
  alert('Logged out successfully');
  window.location.href = 'index.html';
}

// Load dashboard on page load
window.addEventListener('load', () => {
  if (!authToken) {
    alert('Please login first');
    window.location.href = 'index.html';
  } else {
    loadDashboard();
  }
});
</script>
</body>
</html>
